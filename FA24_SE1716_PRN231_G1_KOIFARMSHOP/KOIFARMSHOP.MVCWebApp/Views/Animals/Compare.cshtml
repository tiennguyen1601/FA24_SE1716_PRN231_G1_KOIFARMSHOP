@using KOIFARMSHOP.Data.Models

@{
    ViewData["Title"] = "Compare Koi Fish";
}

<h1 class="text-center">Compare Koi Fish</h1>
<!-- Search Form with Filters for Species, Name, and Origin -->
<form id="searchForm" asp-controller="Animals" method="get" class="form-inline justify-content-center mb-4">
    <div class="input-group">
        <input type="text" id="species" name="species" placeholder="Species" class="form-control mx-2" />
        <input type="text" id="name" name="name" placeholder="Name" class="form-control mx-2" />
        <input type="text" id="origin" name="origin" placeholder="Origin" class="form-control mx-2" />
        <div class="input-group-append">
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </div>
</form>
<!-- Form for selecting fish and attributes to compare -->
<form id="compareForm" method="post">
    @Html.AntiForgeryToken()
    <!-- Koi Fish List -->
    <div class="table-responsive mt-3">
        <table class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>Select</th>
                    <th>Name</th>
                    <th>Origin</th>
                    <th>Species</th>
                    <th>Gender</th>
                    <th>Size</th>
                    <th>Price</th>
                    <th>Health Status</th>
                    <th>Color</th>
                    <th>Farm</th>
                    <th>Birth Year</th>
                    <th>Maintenance Cost</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var fish in Model)
                {
                    <tr>
                        <td><input type="checkbox" name="animalIds" value="@fish.AnimalId" /></td>
                        <td>@fish.Name</td>
                        <td>@fish.Origin</td>
                        <td>@fish.Species</td>
                        <td>@fish.Gender</td>
                        <td>@fish.Size</td>
                        <td>@fish.Price?.ToString("C")</td>
                        <td>@fish.HealthStatus</td>
                        <td>@fish.Color</td>
                        <td>@fish.FarmOrigin</td>
                        <td>@fish.BirthYear</td>
                        <td>@fish.MaintenanceCost?.ToString("C")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="mt-3">
        <h4>Select Attributes to Compare</h4>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" name="selectedAttributes" value="Price" />
            <label class="form-check-label">Price</label>
        </div>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" name="selectedAttributes" value="Gender" />
            <label class="form-check-label">Gender</label>
        </div>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" name="selectedAttributes" value="Size" />
            <label class="form-check-label">Size</label>
        </div>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" name="selectedAttributes" value="HealthStatus" />
            <label class="form-check-label">Health Status</label>
        </div>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" name="selectedAttributes" value="Color" />
            <label class="form-check-label">Color</label>
        </div>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" name="selectedAttributes" value="FarmOrigin" />
            <label class="form-check-label">Farm Origin</label>
        </div>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" name="selectedAttributes" value="BirthYear" />
            <label class="form-check-label">Birth Year</label>
        </div>
        <div class="form-check">
            <input type="checkbox" class="form-check-input" name="selectedAttributes" value="MaintenanceCost" />
            <label class="form-check-label">Maintenance Cost</label>
        </div>
    </div>

    <div class="text-center mt-3">
        <button class="btn btn-primary" type="submit">Compare</button>
    </div>
</form>

<div id="comparisonResults" class="mt-4"></div>

<div id="comparisonMessages" class="mt-3"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {
        loadData();

        $('#searchForm').submit(function (event) {
            event.preventDefault();
            const species = $('#species').val();
            const name = $('#name').val();
            const origin = $('#origin').val();
            loadData(species, name, origin);
        });
    });

    var PageSize = 10;
    var CurrentPage = 1;
    var TotalItems = 0;

    function loadData(species = '', name = '', origin = '') {
        let url;

        // Determine the correct URL based on filter presence
        if (!species && !name && !origin) {
            // No filters applied
            url = `https://localhost:7176/api/Animals/search`;
        } else if (species && !name && !origin) {
            // Only Species filter applied
            url = `https://localhost:7176/api/Animals/search?Species=${encodeURIComponent(species)}`;
        } else if (!species && name && !origin) {
            // Only Name filter applied
            url = `https://localhost:7176/api/Animals/search?Name=${encodeURIComponent(name)}`;
        } else if (!species && !name && origin) {
            // Only Origin filter applied
            url = `https://localhost:7176/api/Animals/search?Origin=${encodeURIComponent(origin)}`;
        } else if (species && name && !origin) {
            // Species and Name filters applied
            url = `https://localhost:7176/api/Animals/search?Species=${encodeURIComponent(species)}&Name=${encodeURIComponent(name)}`;
        } else if (species && !name && origin) {
            // Species and Origin filters applied
            url = `https://localhost:7176/api/Animals/search?Species=${encodeURIComponent(species)}&Origin=${encodeURIComponent(origin)}`;
        } else if (!species && name && origin) {
            // Name and Origin filters applied
            url = `https://localhost:7176/api/Animals/search?Name=${encodeURIComponent(name)}&Origin=${encodeURIComponent(origin)}`;
        } else {
            // All filters applied
            url = `https://localhost:7176/api/Animals/search?Species=${encodeURIComponent(species)}&Name=${encodeURIComponent(name)}&Origin=${encodeURIComponent(origin)}`;
        }

        $.ajax({
            url: url,
            type: 'GET',
            success: function (result) {
                displayAnimals(result.data.data);
            },
            error: function (xhr) {
                alert(`Error: ${xhr.statusText}`);
            }
        });
    }


    // Define displayAnimals function to render the fetched animals into the table
    function displayAnimals(animals) {
        let html = "";
        animals.forEach(animal => {
            html += `<tr>
                        <td><input type="checkbox" name="animalIds" value="${animal.animalId}" /></td>
                        <td>${animal.name}</td>
                        <td>${animal.origin}</td>
                        <td>${animal.species}</td>
                        <td>${animal.gender}</td>
                        <td>${animal.size}</td>
                        <td>${animal.price ? animal.price.toLocaleString('en-US', { style: 'currency', currency: 'USD' }) : ''}</td>
                        <td>${animal.healthStatus}</td>
                        <td>${animal.color}</td>
                        <td>${animal.farmOrigin}</td>
                        <td>${animal.birthYear}</td>
                        <td>${animal.maintenanceCost ? animal.maintenanceCost.toLocaleString('en-US', { style: 'currency', currency: 'USD' }) : ''}</td>
                    </tr>`;
        });
        $('tbody').html(html); // Update the table body with search results
    }

    $('#compareForm').submit(function (e) {
        e.preventDefault();

        $.ajax({
            url: '@Url.Action("PerformComparison", "Animals")',
            type: 'POST',
            data: $(this).serialize(),
            success: function (response) {
                console.log(response);

                if (response.success) {
                    $('#comparisonMessages').html(renderComparisonMessages(response.data.comparisonMessages));
                    $('#comparisonResults').html(renderComparisonResults(response.data));
                } else {
                    alert(response.message);
                }
            }
        });
    });

    function renderComparisonMessages(messages) {
        if (messages && messages.length > 0) {
            let html = '<div class="alert alert-info">';
            html += '<h4>Comparison Messages:</h4><ul>';
            messages.forEach(message => {
                html += `<li>${message}</li>`;
            });
            html += '</ul></div>';
            return html;
        }
        return '';
    }

    function renderComparisonResults(data) {
        let html = "<h2>Comparison Results</h2>";
        data.comparisonResults.forEach(result => {
            html += `<h3>${result.attributeName}</h3><table class="table table-bordered"><thead><tr><th>Koi Fish</th><th>Attribute Value</th></tr></thead><tbody>`;
            for (const [fishId, value] of Object.entries(result.values)) {
                const fish = data.animals.find(a => a.animalId === parseInt(fishId));
                const fishName = fish ? fish.name : `Koi Fish ${fishId}`;
                html += `<tr><td>${fishName}</td><td>${value}</td></tr>`;
            }
            html += "</tbody></table>";
        });
        return html;
    }
</script>

